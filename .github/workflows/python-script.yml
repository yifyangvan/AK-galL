name: Auto Node Update
on:
  schedule:
    - cron: '30 0 * * *'  # åŒ—äº¬æ—¶é—´8:30
  push:
    branches: [main]
    paths:
      - 'dist/GH-AC-main.py'
      - '.github/workflows/python-script.yml'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'æ›´æ–°äº†')"
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Verify Files
      run: |
        echo "ä»“åº“æ–‡ä»¶åˆ—è¡¨:"
        ls -l
        echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶:"
        if [ ! -f GAll.txt ]; then
          echo "::error::ç¼ºå°‘ GAll.txt"
          exit 1
        fi
        if [ ! -f AddIP.txt ]; then
          echo "::error::ç¼ºå°‘ AddIP.txt"
          exit 1
        fi

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        sudo apt-get install -y jq

    - name: Execute Script
      run: |
        python dist/GH-AC-main.py
        cat node_stats.json  # è¾“å‡º node_stats.json æ–‡ä»¶çš„å†…å®¹ï¼Œä¾¿äºè°ƒè¯•
        echo "STATS_JSON=$(cat node_stats.json | jq -c .)" >> $GITHUB_ENV

    - name: Commit Changes and Send Notifications
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  # ä» GitHub Secrets è·å–
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  # ä» GitHub Secrets è·å–
      run: |
        echo "STATS_JSON: $STATS_JSON"
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git remote set-url origin https://x-access-token:$GH_TOKEN@github.com/${{ github.repository }}
        
        # ä» STATS_JSON ä¸­æå– UTC æ—¶é—´æˆ³å¹¶è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
        utc_timestamp=$(echo "$STATS_JSON" | jq -r '.timestamp')
        beijing_timestamp=$(date -u -d "$utc_timestamp 8 hours" '+%Y-%m-%d %H:%M:%S')
        echo "Beijing Timestamp: $beijing_timestamp"

        # æ„å»º Telegram æ¨é€æ¶ˆæ¯
        message="âœ¨ *èŠ‚ç‚¹æ›´æ–°æŠ¥å‘Š* âœ¨\nğŸ“¡ *ç³»ç»Ÿæ—¶é—´*: ${beijing_timestamp}\n\`\`\`\n"
        while IFS= read -r filename; do
          line_count=$(echo "$STATS_JSON" | jq -r ".stats.\"$filename\"")
          if [ -n "$line_count" ]; then
            message="${message}${filename}: æ›´æ–°äº† ${line_count} ä¸ªèŠ‚ç‚¹\n"
          fi
          
          # Git æäº¤
          git add "$filename" || echo "æ–‡ä»¶ $filename æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ·»åŠ "
          commit_msg="æ›´æ–°äº† ${line_count} ä¸ªèŠ‚ç‚¹ åŒ—äº¬æ—¶é—´ ${beijing_timestamp}"
          git commit -m "$commit_msg" --allow-empty || echo "æäº¤ $filename å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ— å˜æ›´"
        done < <(echo "$STATS_JSON" | jq -r '.stats | keys_unsorted[]')
        message="${message}\`\`\`"

        # è°ƒè¯•ï¼šè¾“å‡ºæœ€ç»ˆæ¶ˆæ¯
        echo "Telegram Message:"
        echo -e "$message"

        # å¦‚æœæ¶ˆæ¯ä¸ºç©ºï¼Œè®°å½•é”™è¯¯
        if [ -z "$message" ]; then
          echo "é”™è¯¯ï¼šæ¨é€æ¶ˆæ¯ä¸ºç©ºï¼Œæ£€æŸ¥ node_stats.json æ˜¯å¦æ­£ç¡®ç”Ÿæˆ"
          exit 1
        fi

        # å‘é€ Telegram æ¨é€ï¼ˆä½¿ç”¨ Markdown æ ¼å¼ï¼‰
        curl -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}&text=$(echo -e "$message")&parse_mode=Markdown" || echo "Telegram æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æˆ– Chat ID"
        
        # æ¨é€ Git å˜æ›´
        git push origin main || echo "æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
