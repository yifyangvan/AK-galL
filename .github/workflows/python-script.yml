name: Run Python Script

on:
  schedule:
    - cron: '0 17 * * *'  # æ¯å¤©å®šæ—¶è¿è¡Œï¼ˆUTC 17:00ï¼ŒåŒ—äº¬æ—¶é—´ 1:00ï¼‰
  push:
    branches:
      - main
    paths:
      - 'dist/GH-AC-main.py'
      - '.github/workflows/python-script.yml'
  workflow_dispatch:

jobs:
  run_script:
    if: "!contains(github.event.head_commit.message, 'æ›´æ–°äº†')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Python script
        run: |
          echo "ç¨‹åºå¼€å§‹è¿è¡Œ..."
          python dist/GH-AC-main.py
          echo "ç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚"

      - name: Commit each TXT individually
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git

          current_datetime=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          need_push=false

          # ä¿®å¤æ–‡ä»¶åä¸­çš„ç‚¹å·åŒ¹é…é—®é¢˜
          declare -A file_map=(
            ["GAll.(ä¼˜é€‰-tls).txt"]="ä¼˜é€‰-tls"
            ["GAll.(ä¼˜é€‰-étls).txt"]="ä¼˜é€‰-étls"
            ["GAll.(éä¼˜é€‰).txt"]="éä¼˜é€‰"
            ["æ›¿æ¢_GAll.(ä¼˜é€‰-tls).txt"]="æ›¿æ¢ä¼˜é€‰-tls"
            ["æ›¿æ¢_GAll.(ä¼˜é€‰-étls).txt"]="æ›¿æ¢ä¼˜é€‰-étls"
          )

          for file in "${!file_map[@]}"; do
            if [[ -f "$file" ]]; then
              # è·å–æ–‡ä»¶æ—§ç‰ˆæœ¬å†…å®¹
              old_hash=$(git rev-parse HEAD:"$file" 2>/dev/null || echo "null")
              new_hash=$(git hash-object "$file")

              # ä»…å½“æ–‡ä»¶æœ‰å˜æ›´æ—¶æäº¤
              if [[ "$old_hash" != "$new_hash" ]]; then
                line_count=$(wc -l < "$file")
                message="æ›´æ–°äº† ${file_map[$file]} ${line_count}èŠ‚ç‚¹ ($current_datetime)"
                
                git add "$file"
                git commit -m "$message"
                need_push=true
                echo "âœ… å·²æäº¤ $file å˜æ›´"
              else
                echo "ğŸŸ¡ $file æ— å†…å®¹å˜åŒ–"
              fi
            else
              echo "ğŸ”´ $file æ–‡ä»¶æœªç”Ÿæˆ"
            fi
          done

          if $need_push; then
            git pull --rebase origin main
            git push origin main
            echo "ğŸš€ å·²æ¨é€æ‰€æœ‰å˜æ›´"
          else
            echo "ğŸŸ¢ æ²¡æœ‰éœ€è¦æ¨é€çš„å˜æ›´"
          fi
